---
title: "Methods and Results"
author: Kristoffer Wild
date: "`r Sys.Date()`"
output: 
  word_document:
    reference_docx: template.docx
editor_options: 
  chunk_output_type: console
---

``````{r setup, include=FALSE, eval = T, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
options(digits = 2)
rm(list=ls())
sessionInfo()
# Packages
pacman::p_load("dplyr", "tidyverse", "lubridate", "ggplot2", "plotly", "pbapply","car", "readr", "lmerTest", "emmeans", "AICcmodavg", "nls.multstart", "broom", "purrr", "plotrix", "AICcmodavg", "MuMIn", "stargazer", "jtools", "huxtable", "officer", "grid", "png", "ggimage", "rTPC", "nls.multstart", "ggrepel", "mgcv", "gratia", "gammit", "lubridate", "lmerTest","performance", "kableExtra","flextable")
```

# Results
```{r IQR results, echo = FALSE, include = FALSE}
######## Tsel data by sex
setwd("~/Dropbox/PhD Pogona/Dissertation/4.Thermal_chapter/R")
# import data
Tsel <- read.csv(file = "Tsel_Tb/Final_TselTb_file.csv" ) %>% 
  rename(temp = mean_temp) %>% 
  filter(Sex != "ZZf")

# sample size
Tsel.Samplesize <- Tsel %>%
  group_by(id, Sex) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  group_by(Sex) %>% 
  summarise(n = n()) %>% 
  mutate(total.sample.size = sum(n),
         total.n.Tb.samples = 4177) %>% 
  as.data.frame()
# differences overall Tb by sex in the lab? 
IQR.Summary <- readRDS(file = "Final.Analysis/Final.Figure.data/IQR.Final.RDS")

# Mean - significant females are higher
Mean.Tel <- lm(Mean.Tb ~Sex, data = IQR.Summary)
Mean.Tel.anova <- round(as.data.frame(anova(Mean.Tel)), digits = 3)

# lower- significant females are higher
IQR.lower <- lm(lower.IQR ~Sex,  data = IQR.Summary)
IQR.lower.anova <- round(as.data.frame(anova(IQR.lower)), digits = 3)

# upper- NS: same across the board
IQR.upper <- lm(upper.IQR ~Sex,  data = IQR.Summary)
IQR.upper.anova <-round(as.data.frame(anova(IQR.upper)), digits = 3)

# saved table with analysis 
Tsel.sex.tbl <- readRDS(file = "Final.Analysis/Final.Figure.data/Tsel.table.RDS")
Tsel.sex.tbl <- as.data.frame(Tsel.sex.tbl)

#######
# Tb vs Tsurf subset in lab
####### 
# estimating Tb correction
setwd("~/Dropbox/PhD Pogona/Dissertation/4.Thermal_chapter/R")
lab.tb <- read.csv("TselvsTsurf.csv", header = T) %>% 
  drop_na() %>% 
  select(c(Lizard, Date, Time, Date.Time, Tsurf.Temp, Tsel.temp, Time.of.Day))
lab.tb$Date.Time <- dmy_hm(lab.tb$Date.Time)
lab.tb$hr <- hour(lab.tb$Date.Time)
# Tb Vs. Tsurf model
Tb.Tsurf.mod <- lm(Tsurf.Temp ~Tsel.temp, data = lab.tb)
Tb.Tsurf.tbl <- round(anova(Tb.Tsurf.mod), digits = 3)
Tb.Tsurf.R2 <- round(r.squaredLR(Tb.Tsurf.mod), digits = 3)

# paired t test for Tb and tsurf
t.test <- t.test(lab.tb$Tsel.temp, lab.tb$Tsurf.Temp, paired = TRUE, alternative = "two.sided")
lab.tb.sum <- lab.tb %>% 
  summarise()
```
*3.1 | Preferred body temperature estimation (Tset) and body temperature calibration*
<p> Twenty lizards (Male: n =10; Female: n =10) were used to determine Tset from laboratory Tb.  Mean Tb was significantly different between sex (F1,18 = 7.24; p <0.05), where females (30.4±0.56°C ) had a higher mean Tb than males (28.3±0.56°C). A similar relationship was observed when comparing 75% quantile measurements (F1,18 = 4.78; p <0.05), where females (33.8±0.92°C ) had higher estimates than males (29.0±0.92°C). There were differences in 25% quantile measurements (F1,18 = 4.77; p <0.05), where females had lower estimates (27.0±0.46°C) than males (25.5±0.46°C).
When testing the relationship between laboratory Tb and Tsurf, we recorded a total of 16,938 paired Tb and Tsurf measurements for 10 individuals. There was a strong relationship between the two variables (R^2 = 0.94; F_1,16937 = 2469723; p < 0.01; Fig. S2), but because Tsurf temperatures slightly overestimated (paired t = 12.21; df = 16,938; p < 0.01) Tb by 0.12°C (±0.01). Therefore, Tsurf was corrected for Tb predict using the equation:
Tb Predict = 1.770 + (Tsurf = 1.058) <p>
```{r Tb predict results, echo = FALSE, include = FALSE}
####################  
#####  Field temperature Spring 2018- Winter 2019: Applying Tset to tb predicted
####################
# Note: data has been filtered between 0500-2100 during spring 2018-winter2019;
# data has filtered out individuals that had less than 7 days of data
# applied Tb predicition from lab regression: Tb = a + Tsurf*b : where a = -1.770131; b = 1.057887
setwd("~/Dropbox/PhD Pogona/Dissertation/4.Thermal_chapter/R")
#######
# Tb body temperature for individuals by sex and season
#######
db.sex.all.final <- readRDS(file = "Final.Analysis/Final.Figure.data/db.final.RDS")
Tb.sample.size <- db.sex.all.final %>% ungroup() %>% group_by(Season) %>% summarise(n =n())
Tb.mod <- lmer(Tb  ~ Sex + Season + Season*Sex + (1|POVI), db.sex.all.final)
Tb.mod.sum <- round(as.data.frame(anova(Tb.mod)), digits = 3) # NS Sex; Significant interaction and season
Tb.anova.pairwise <- emmeans(Tb.mod, pairwise~ Sex |Season,  lmerTest.limit = 67884) # Just summer differences 
#  just season
Tb.anova.pairwise.season <- emmeans(Tb.mod, pairwise ~ Season, lmerTest.limit = 67884) 

#### Supplementary tables
# TABLE S2 by season * sex interaction - Contrasts 
S2.Tb.Sex.Season.tbl <- as.data.frame(Tb.anova.pairwise$contrasts)
# TABLE S3 by season - Contrasts
S3.Tb.Sex.Season.tbl <- as.data.frame(Tb.anova.pairwise.season$contrasts)


####################  
# Model calibration results
####################  
# bring in model callibration for Tb vs Te
Te.Calibration <- read.csv(file = "Final.Analysis/Final.Figure.data/Model.vs.TB.Clean.2min.csv")
Te.Calibration.Results <- lm(Model_temp ~ Tb_dead, Te.Calibration)
Te.Calibration.Results.anova <- round(as.data.frame(anova(Te.Calibration.Results)), digits = 3) 
Te.Calibration.mod.tbl <- as.data.frame(Te.Calibration.Results.anova)
Te.calibration.R2 <- as.data.frame(round(r.squaredLR(Te.Calibration.Results), digits = 3))
te.test <- t.test(Te.Calibration$Model_temp, Te.Calibration$Tb_dead, paired = TRUE, alternative = "two.sided")

# bring in Te data where calibration has been included and we've calculated Te and de values accounting for season and sex
Te <- readRDS(file = "Final.Analysis/Final.Figure.data/Te.sex.final.RDS") 
Te.sample.size <- Te %>% ungroup %>% group_by(Season) %>% summarise(n =n())
Te.analysis <- Te %>% 
  group_by(Date, Season)%>%
  summarise(Max = max(Te),
            Min = min(Te),
            Mean = mean(Te)) 
# te mean
Te.mean.mod <- lm(Mean  ~ Season, Te.analysis)
Te.mean.mod.sum <- round(as.data.frame(anova(Te.mean.mod)), digits = 3)
Te.anova.pairwise <- emmeans(Te.mean.mod, pairwise ~ Season) 


#######
# db values for individuals by sex and season
#######
# note these data are summarised by inividual, date, by the hour. Season, sex are unique
db.final.mod <- lmer(individual_db ~ Sex + Season + Season*Sex + (1|POVI), db.sex.all.final)
db.anova.sum <- round(as.data.frame(anova(db.final.mod)), digits = 3)# no sex differences but interaction and season effect
db.anova.pairwise <- emmeans(db.final.mod, pairwise ~ Sex | Season)
db.mod.season.tbl <- as.data.frame(db.anova.pairwise$contrasts)

#### Supplementary tables
# TABLE S4 by season * sex interaction - Contrasts 
S2.Tb.Sex.Season.tbl <- as.data.frame(Tb.anova.pairwise$contrasts)

####################  
# de values for individual models by season
####################  
#analysis for de by sex and season
definal.mod <- lmer(de ~ Te.Analysis + Season + Te.Analysis*Season + + (1|Model_.), Te)
de.anova.sum <- round(as.data.frame(anova(definal.mod)), digits = 3) %>% mutate("Pr(>F)" = "< 0.01")# significant all around
de.mod.season.sex <- emmeans(definal.mod, pairwise ~ Te.Analysis | Season) # this just says the available environment is easier for females to thermoregulate
de.mod.season.sex.tbl<- as.data.frame(de.mod.season.sex$emmeans)

####################  
# Eindex by (individual or Models) by individual and season db -de/100
####################  
E_final_season <- readRDS(file = "Final.Analysis/Final.Figure.data/E_season_sex_individual.RDS")
E.mod <- lmer(indvidual_season_E  ~ Sex + Season + Season*Sex + (1|POVI), E_final_season)
E.mod.Sum <- round(as.data.frame(anova(E.mod)), digits = 3) # significant all around
E.anova.pairwise <- emmeans(E.mod, pairwise ~ Sex |Season) # sex differences in the spring and summer
E.mod.season.sex.tbl<- as.data.frame(E.anova.pairwise$emmeans)
```
*3.2 Field predicted body temperatures and environmental temperatures* 
<p>Accelerometers were placed on 40 individual P. vitticeps (Male: n = 32; Female: n = 8) that were tracked between Spring 2018 and Winter 2019. Sex had no overall effect Tb predict (P = 0.40; Table 2), but there was a significant overall effect on season (P<0.01) and the season × sex interaction (P<0.01). Least squares estimates of differences in seasonal Tb predict between sex indicated only during the summer females had higher Tb predict than males and all other seasons there were no differences between sex (Fig 2; Table S2). There were overall differences in Tb predict among seasons (Tukey-Kramer p <0.05; Table S3), where summer had the highest overall mean 33.4°C (±0.25), followed by spring 29.2 °C (±0.27), autumn 26.5°C (±0.25), and winter 20.8°C (±0.25).<p>
<p> The relationship between temperature of the copper models (Te) and Tb of lizard carcass was significant (R2 = 0.85, F1,1174 = 6740; p < 0.01), but because Te did slightly overestimate Tb by 0.49±0.10°C (paired t = 4.71; df = 1,175; p < 0.01), temperatures of models were adjusted using the equation:
Te=8.159055+(T_e⋅0.711953)
A total of 329,324 Te measurements were recorded continuously in five habitat types from Spring 2018 to Winter 2019. Mean Te was different across all seasons (F_3,329321 = 371.03; p < 0.01), where Te increased in the spring and summer seasons and decreased in autumn and winter seasons (Fig. 2).<p> 
```{r db de e results, echo = FALSE, include = FALSE}
#######
# db values for individuals by sex and season
#######
# note these data are summarised by inividual, date, by the hour. Season, sex are unique
db.final.mod <- lmer(individual_db ~ Sex + Season + Season*Sex + (1|POVI), db.sex.all.final)
db.anova.sum <- round(as.data.frame(anova(db.final.mod)), digits = 3)# no sex differences but interaction and season effect
db.anova.pairwise <- emmeans(db.final.mod, pairwise ~ Sex | Season)
db.mod.season.tbl <- as.data.frame(db.anova.pairwise$contrasts)

#### Supplementary tables
# TABLE S4 by season * sex interaction - Contrasts 
S2.Tb.Sex.Season.tbl <- as.data.frame(Tb.anova.pairwise$contrasts)

####################  
# de values for individual models by season
####################  
#analysis for de by sex and season
definal.mod <- lmer(de ~ Te.Analysis + Season + Te.Analysis*Season + + (1|Model_.), Te)
de.anova.sum <- round(as.data.frame(anova(definal.mod)), digits = 3) %>% mutate("Pr(>F)" = "< 0.01")# significant all around
de.mod.season.sex <- emmeans(definal.mod, pairwise ~ Te.Analysis | Season) # this just says the available environment is easier for females to thermoregulate
de.mod.season.sex.tbl<- as.data.frame(de.mod.season.sex$emmeans)

####################  
# Eindex by (individual or Models) by individual and season db -de/100
####################  
E_final_season <- readRDS(file = "Final.Analysis/Final.Figure.data/E_season_sex_individual.RDS")
E.mod <- lmer(indvidual_season_E  ~ Sex + Season + Season*Sex + (1|POVI), E_final_season)
E.mod.Sum <- round(as.data.frame(anova(E.mod)), digits = 3) # significant all around
E.anova.pairwise <- emmeans(E.mod, pairwise ~ Sex |Season) # sex differences in the spring and summer
E.mod.season.sex.tbl<- as.data.frame(E.anova.pairwise$emmeans)
```
*3.3 | Indices of thermoregulation* 
<p>Each index of thermoregulation (db , de, E) accounted for sex differences in Tset detected in thermal gradient study (section 3.1), therefore for db and de the appropriate quantile (25% and 75%) of Tsel was applied for each sex. Then db and de was determined across season, sex and the interaction. There was no overall effect of sex on db estimates (Table 2), but season and the interaction had an overall effect on db (Fig. 2A). Least squares estimates of differences in seasonal db between sex indicated males thermoregulated more accurately (i.e. low db) than females during spring, and females thermoregulating more accurately than males during the summer and winter (Fig. 2A; Tukey-Kramer p <0.05). There were no differences in db values between males in females in the autumn (Fig. 2A). The thermal quality of the habitat (de) varied between sex, across seasons, and the interaction (Table 2). Least squares estimates indicated the thermal environment was more favourable (i.e. lower de) for females compared to males in the spring, summer, and autumn (Fig. 2B; Tukey-Kramer p <0.05). However, there were no differences in de between sexes during winter (Fig. 2B). <p>
<p> There was no overall effect of sex on effectiveness of thermoregulation (E), but season and the interaction had an overall effect on E (Table 2 & Fig. 4). Least squares estimates in seasonal E index between sex indicated E varied significantly between males and females only during the spring season (Fig. 4; Tukey-Kramer p <0.05). During the spring, females demonstrated thermoconforming behaviours (i.e. low E values) and males demonstrated thermoregulating behaviors (i.e. high E values). During the summer both male and female lizards appeared to be thermoregulating, whereas in the autumn and winter lizards decreased thermoregulatory behavior and began to conform to their environment (Fig. 4). <p>
```{r Activity and GAMM, echo = FALSE, include = FALSE}
####################  
#####  Field accelerometer data for avg mins moved analysis
####################
setwd("~/Dropbox/PhD Pogona/Dissertation/4.Thermal_chapter/R")
# raw acceleration points before summary
raw.data <- readRDS(file = "Final.Analysis/Final.Figure.data/avg.min.floor.final.clean.RDS")
raw.data.sample.size <- nrow(raw.data)
# Analysis - Accelerometer
# Note: Needed to log transform movement min +1log because of high frequencies of zeros
act.analysis.dat <- readRDS(file = "Final.Analysis/Final.Figure.data/activity.season.sex.analysis.data.RDS")
activity.analysis.mod <- lmer(log1p(Movement.HR)  ~ Sex + Season + Season*Sex + (1|POVI), act.analysis.dat)
activity.analysis.mod.final <- as.data.frame(anova(activity.analysis.mod)) # no differences in sex or interaction; season had largest effect 
Activity.pairwise <- emmeans(activity.analysis.mod, pairwise ~ Season) # sex differences in the spring and summer
Activity.Season.tbl <- as.data.frame((Activity.pairwise$contrasts))
Activity.Season.tbl$p.value <- round(Activity.Season.tbl$p.value, digits = 3)

####################  
#####  GAMM for season and sex interaction 
####################
data.gam <- readRDS(file = "Final.Analysis/Final.Figure.data/data.temp.gam.analysis.rds")
# top model
Season.Sex.Interaction.Povi <- readRDS(file = "Models/Season.Sex.Interaction.Povi.rds")
# model table
GAM.Table <- read.csv(file = "Final.Analysis/Final.Figure.data/GAMM.anova.table.csv")

######
# theoretical TPC model a
Temp <- readRDS(file = "Models/Temp.rds")
tem.gam.data = data.gam
tem.gam.data$fit <- predict(Temp, type = "response")
tem.gam.data$se <- predict(Temp, type = "se")

# TPC parameters from GAMM To, Tb from top model
Gam.anova <- anova(Season.Sex.Interaction.Povi)
Gam.anova.sum <- summary.gam(Season.Sex.Interaction.Povi)
data.gam$fit <- predict(Season.Sex.Interaction.Povi, type = "response")
data.gam$se <- predict(Season.Sex.Interaction.Povi, type = "se")

# calculate range of temps for activity for start of paragraph
Gam.range <- data.gam %>% select(temp, Season, Sex, Tb, fit) %>% 
  filter(fit > 0)
Gam.range.final <- Gam.range %>% group_by(Season) %>% 
  summarise(range = range(temp))

# summarizing To by id, Sex, Season
Pmax <- data.gam %>% 
  group_by(POVI, Sex, Season) %>% 
  filter(fit == max(fit)) %>% 
  rename(Pmax = fit)

Pmax.final <- Pmax %>% 
  group_by(POVI, Sex, Season) %>% 
  summarise(Pmax.temp = mean(Tb),
            Pmax = mean(Pmax))
#######
# analysis for Pmax - speed
To.mod <- lmer(Pmax  ~ Season + Sex + Season*Sex  + (1|POVI), Pmax.final)
To.mod.sum <- as.data.frame(anova(To.mod)) # no differences between sex, but significant seasona and interaction
Pmax.Sex.Season <- emmeans(To.mod, pairwise ~ Sex |Season) 
# extracting season sex contrasts
Pmax.Sex.Season.df <- as.data.frame(Pmax.Sex.Season$emmeans) %>% 
  select(c(Season, emmean, SE, Sex, lower.CL, upper.CL))
# extracting seasonal contrasts
Pmax.Season <- emmeans(To.mod, pairwise ~ Season)
Pmax.Season.df <- as.data.frame(Pmax.Season$contrasts)

#######
# analysis for Pmax - temperature
To.temp.mod <- lmer(Pmax.temp  ~ Season + Sex + Season*Sex  + (1|POVI), Pmax.final)
To.temp.mod.sum <- anova(To.temp.mod) # no differences at all
Pmax.temp.sex.season <- as.data.frame(To.temp.mod.sum) 
Pmax.temp.mean.se <-Pmax.final %>% ungroup() %>%  summarise(Pmax.temp.mean = mean(Pmax.temp),
                                             Pmax.temp.se = std.error(Pmax.temp)) 
```
*3.4 Seasonal activity and Thermal Performance Curves:* 
<p>A total of 6,858,857 raw acceleration data points were collected on male (n = 32) and female (n = 8) P. vitticeps from spring 2018 to winter 2019. There were many instances where individuals were not moving (i.e. no changes in acceleration), so for the analysis, we log-transformed (log(x+1)) movement rate (min/h). Average movement varied across the season (F_3,81 = 9.25; p < 0.01), but there were no differences between sex (F_1,68 = 0.23; p = 0.63) or the interaction (F_3,81 = 0.29; p = 0.83). Overall activity was highest in the summer and then decreased in spring and autumn (Fig. 5; Table S4). Winter activity was significantly lower than all other seasons (Table S4). 
The top candidate GAMM model (ΔAIC score < 2) was the full model, which accounted for season, sex and their interaction allowing for random intercept and smoothed spline per individual (Table S4). This model explained 71% of the total deviance (Fig. 6). The next best models included season and sex or just season as fixed factors with a random intercept and smooth per individual lizard. Although these models explained 70% of deviance, they had ΔAIC scores > 2 (Table S4). In general, TPC GAMM models showed a rise in the explanation of deviance when incorporating parameters that consider differences among individuals and season (Table S4). Predicted maximum performance (P_Max) was then extracted from the top candidate model and Pmax ranged from 0.22-1.64 ms^2 (Fig. 6). There was no overall effect of sex on Pmax (F_1,90 = 0.34; p = 0.56), but there was an overall effect of Pmax on season (F_3,88 = 112.73; p < 0.01) and the interaction (F_3,88 = 76.07; p < 0.01). Least squares estimates showed that Pmax peaked significantly during the spring season, whereas winter recorded a notably lower Pmax relative to all other seasons. (Tukey-Kramer p <0.05; Table S5). Although females exhibited higher Pmax values in autumn and winter, and males demonstrated higher values in spring and summer, least squares estimates suggested that these differences were not statistically significant (Table S6). The temperatures at which performance was optimised (Topt) averaged 36.7±0.24°C across all seasons, but we found no significant difference between sex (F_1,90 = 0.57; p = 0.64), across seasons (F_3,88 = 0.24; p = 0.63), or their interaction (F_3,88 = 1.79; p = 0.64).<p> 
```{r Applying thermal and performance parameters to survival results, echo = FALSE, include = FALSE}
# mark table and results
setwd("~/Dropbox/PhD Pogona/Dissertation/4.Thermal_chapter/R")
# model table
mark.tbl <- read.csv(file = "Final.Analysis/Final.Figure.data/MARK.Table.csv")
# 27 total animals tracked during this time: 8 died 19 lived
# average percentage to survive for males:  mean: 0.7500000   Se:0.0883883
# average percentage to survive for females: mean:0.3333333   Se:0.2721655 
                          
```
*3.5 | Applying thermal and performance parameters to survival* 
<p>During the spring twenty-seven lizard were tracked, eight of which died during this period. Survival probabilities (mean ± SE) were higher for males (0.75±0.08) than females (0.33±0.20). For the known-fate model covariates, effect of sex was adjusted for db and E to account for sex differences in the spring (Figs. 2B & 3). The top competing model accounted for sex and E index (ΔAICc = 0.00, weight = 0.42), which indicated that individuals that thermoregulated more effectively (high E values) had a higher probability of surviving than those who thermoconformed (low E values; Fig 7). The next supporting models were the constant model (ΔAICc = 1.56, weight = 0.19) and the model that accounted for sex differences alone (ΔAICc = 1.90, weight = 0.16; Table S7).<p>
